<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>imvault — Conversation</title>
<style>
:root {
  --bg: #fff;
  --chat-bg: #f2f2f7;
  --sent-bg: #007aff;
  --sent-text: #fff;
  --recv-bg: #e5e5ea;
  --recv-text: #000;
  --text-primary: #000;
  --text-secondary: #8e8e93;
  --header-bg: rgba(255,255,255,0.92);
  --border: #c6c6c8;
  --search-bg: #e5e5ea;
}
.dark {
  --bg: #000;
  --chat-bg: #000;
  --sent-bg: #0b84fe;
  --sent-text: #fff;
  --recv-bg: #26252a;
  --recv-text: #fff;
  --text-primary: #fff;
  --text-secondary: #8e8e93;
  --header-bg: rgba(0,0,0,0.92);
  --border: #38383a;
  --search-bg: #1c1c1e;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
  background: var(--chat-bg);
  color: var(--text-primary);
  height: 100vh;
  display: flex;
  flex-direction: column;
}
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--header-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 0.5px solid var(--border);
  padding: 12px 16px;
  text-align: center;
}
.header h1 {
  font-size: 17px;
  font-weight: 600;
}
.header .subtitle {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
}
.toolbar {
  display: flex;
  gap: 8px;
  padding: 8px 16px;
  background: var(--header-bg);
  backdrop-filter: blur(20px);
  border-bottom: 0.5px solid var(--border);
  align-items: center;
  flex-shrink: 0;
}
.search-box {
  flex: 1;
  padding: 8px 12px;
  border-radius: 10px;
  border: none;
  background: var(--search-bg);
  color: var(--text-primary);
  font-size: 15px;
  outline: none;
}
.btn {
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 13px;
  white-space: nowrap;
  flex-shrink: 0;
}
.btn:hover { opacity: 0.8; }
.chat-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 8px 16px 16px;
  scroll-behavior: smooth;
}
.load-earlier {
  text-align: center;
  padding: 12px;
}
.load-earlier button {
  padding: 8px 20px;
  border-radius: 20px;
  border: none;
  background: var(--recv-bg);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 14px;
}
.date-header {
  text-align: center;
  padding: 16px 0 8px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
}
.message-row {
  display: flex;
  margin-bottom: 2px;
}
.message-row.sent { justify-content: flex-end; }
.message-row.received { justify-content: flex-start; }
.bubble {
  max-width: 70%;
  padding: 8px 12px;
  border-radius: 18px;
  position: relative;
  word-wrap: break-word;
  overflow-wrap: break-word;
  line-height: 1.4;
  font-size: 16px;
}
.sent .bubble {
  background: var(--sent-bg);
  color: var(--sent-text);
  border-bottom-right-radius: 4px;
}
.received .bubble {
  background: var(--recv-bg);
  color: var(--recv-text);
  border-bottom-left-radius: 4px;
}
.sender-label {
  font-size: 11px;
  color: var(--text-secondary);
  margin-bottom: 2px;
  padding-left: 12px;
}
.timestamp {
  font-size: 10px;
  color: var(--text-secondary);
  margin-top: 2px;
  padding: 0 12px;
}
.sent .timestamp { text-align: right; }
.attachment { margin-top: 4px; overflow: hidden; }
.attachment img {
  max-width: min(240px, 100%);
  max-height: 240px;
  border-radius: 12px;
  display: block;
}
.attachment video {
  max-width: min(240px, 100%);
  border-radius: 12px;
  display: block;
}
.attachment a {
  color: inherit;
  text-decoration: underline;
}
.reactions {
  display: flex;
  gap: 4px;
  margin-top: 4px;
  flex-wrap: wrap;
}
.reaction-badge {
  font-size: 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 2px 6px;
  display: inline-flex;
  align-items: center;
  gap: 2px;
}
.search-highlight {
  background: #ffd60a;
  color: #000;
  border-radius: 2px;
}
.hidden { display: none !important; }

/* Gallery view */
.gallery-container {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  background: var(--chat-bg);
}
.gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 8px;
}
.gallery-item {
  aspect-ratio: 1;
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  position: relative;
  background: var(--recv-bg);
}
.gallery-item img, .gallery-item video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.gallery-item .video-badge {
  position: absolute;
  bottom: 4px;
  right: 4px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 11px;
}
.gallery-item .date-badge {
  position: absolute;
  bottom: 4px;
  left: 4px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
}
.gallery-empty {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--text-secondary);
  font-size: 16px;
}
.lightbox {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.lightbox img, .lightbox video {
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 8px;
}
.lightbox-close {
  position: absolute;
  top: 16px;
  right: 16px;
  color: #fff;
  font-size: 32px;
  cursor: pointer;
}
</style>
</head>
<body>
<div class="header">
  <h1 id="chatTitle">Conversation</h1>
  <div class="subtitle" id="chatSubtitle"></div>
</div>
<div class="toolbar">
  <input type="text" class="search-box" id="searchBox" placeholder="Search messages...">
  <button class="btn" id="viewToggle">Attachments</button>
  <button class="btn" id="darkToggle">Dark</button>
</div>
<div class="chat-container" id="chatContainer">
  <div class="load-earlier hidden" id="loadEarlier">
    <button onclick="loadEarlierMessages()">Load Earlier Messages</button>
  </div>
  <div id="messages"></div>
</div>
<div class="gallery-container hidden" id="galleryContainer">
  <div class="gallery-grid" id="galleryGrid"></div>
</div>

<script>
const CHUNK = 200;
const REACTION_EMOJI = {
  "Loved": "\u2764\ufe0f", "Liked": "\ud83d\udc4d", "Disliked": "\ud83d\udc4e",
  "Laughed": "\ud83d\ude02", "Emphasized": "\u203c\ufe0f", "Questioned": "\u2753",
  "-Loved": "", "-Liked": "", "-Disliked": "", "-Laughed": "", "-Emphasized": "", "-Questioned": ""
};

let allMessages = [];
let displayedStart = 0;
let chatData = null;

async function init() {
  const resp = await fetch("data.json");
  chatData = await resp.json();
  const chat = chatData.chat;
  document.getElementById("chatTitle").textContent = chat.display_name || chat.chat_identifier || "Conversation";
  const parts = chat.participants || [];
  if (parts.length > 0) {
    document.getElementById("chatSubtitle").textContent = parts.join(", ");
  }
  allMessages = chatData.messages || [];
  displayedStart = Math.max(0, allMessages.length - CHUNK);
  renderMessages();
  if (displayedStart > 0) document.getElementById("loadEarlier").classList.remove("hidden");
  scrollToBottom();
}

function scrollToBottom() {
  const c = document.getElementById("chatContainer");
  c.scrollTop = c.scrollHeight;
}

function loadEarlierMessages() {
  const prevStart = displayedStart;
  displayedStart = Math.max(0, displayedStart - CHUNK);
  renderMessages();
  if (displayedStart === 0) document.getElementById("loadEarlier").classList.add("hidden");
}

function renderMessages() {
  const container = document.getElementById("messages");
  const subset = allMessages.slice(displayedStart);
  const isGroup = (chatData.chat.style === 43) || (chatData.chat.participants && chatData.chat.participants.length > 1);
  let html = "";
  let lastDate = "";
  for (const msg of subset) {
    const dateStr = msg.date ? msg.date.substring(0, 10) : "";
    if (dateStr && dateStr !== lastDate) {
      html += `<div class="date-header">${formatDate(dateStr)}</div>`;
      lastDate = dateStr;
    }
    const dir = msg.is_from_me ? "sent" : "received";
    html += `<div class="message-row ${dir}" data-text="${escapeAttr(msg.text || "")}">`;
    if (!msg.is_from_me && isGroup) {
      html += `<div style="width:100%"><div class="sender-label">${escapeHtml(msg.sender)}</div>`;
    } else if (!msg.is_from_me) {
      html += `<div style="width:100%">`;
    } else {
      html += `<div style="width:100%;display:flex;flex-direction:column;align-items:flex-end">`;
    }
    html += `<div class="bubble">`;
    if (msg.text) html += escapeHtml(msg.text);
    for (const att of (msg.attachments || [])) {
      html += renderAttachment(att);
    }
    if (msg.reactions && msg.reactions.length > 0) {
      html += `<div class="reactions">`;
      const grouped = {};
      for (const r of msg.reactions) {
        if (r.type.startsWith("-")) continue;
        const emoji = REACTION_EMOJI[r.type] || r.type;
        grouped[emoji] = (grouped[emoji] || 0) + 1;
      }
      for (const [emoji, count] of Object.entries(grouped)) {
        html += `<span class="reaction-badge">${emoji}${count > 1 ? " " + count : ""}</span>`;
      }
      html += `</div>`;
    }
    html += `</div>`;
    if (msg.date) {
      html += `<div class="timestamp">${formatTime(msg.date)}</div>`;
    }
    html += `</div></div>`;
  }
  container.innerHTML = html;
}

function renderAttachment(att) {
  const mime = att.mime_type || "";
  const path = att.path || "";
  const name = att.transfer_name || path.split("/").pop() || "attachment";
  if (mime.startsWith("image/")) {
    return `<div class="attachment"><img src="${escapeAttr(path)}" alt="${escapeAttr(name)}" loading="lazy"></div>`;
  }
  if (mime.startsWith("video/")) {
    return `<div class="attachment"><video src="${escapeAttr(path)}" controls preload="metadata"></video></div>`;
  }
  if (mime.startsWith("audio/")) {
    return `<div class="attachment"><audio src="${escapeAttr(path)}" controls preload="metadata"></audio></div>`;
  }
  return `<div class="attachment"><a href="${escapeAttr(path)}" target="_blank">${escapeHtml(name)}</a></div>`;
}

function formatDate(iso) {
  try {
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, { weekday: "long", year: "numeric", month: "long", day: "numeric" });
  } catch { return iso; }
}

function formatTime(iso) {
  try {
    const d = new Date(iso);
    return d.toLocaleTimeString(undefined, { hour: "numeric", minute: "2-digit" });
  } catch { return ""; }
}

function escapeHtml(s) {
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}
function escapeAttr(s) {
  return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// Search
document.getElementById("searchBox").addEventListener("input", function() {
  const q = this.value.toLowerCase().trim();
  const rows = document.querySelectorAll(".message-row");
  if (!q) {
    rows.forEach(r => r.classList.remove("hidden"));
    return;
  }
  rows.forEach(r => {
    const text = (r.dataset.text || "").toLowerCase();
    r.classList.toggle("hidden", !text.includes(q));
  });
});

// Dark mode
document.getElementById("darkToggle").addEventListener("click", function() {
  document.documentElement.classList.toggle("dark");
  this.textContent = document.documentElement.classList.contains("dark") ? "Light" : "Dark";
});

// Prefer system dark mode
if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
  document.documentElement.classList.add("dark");
  document.getElementById("darkToggle").textContent = "Light";
}

// Gallery view
let viewMode = "messages";

function collectAttachments() {
  const attachments = [];
  for (const msg of allMessages) {
    for (const att of (msg.attachments || [])) {
      const mime = att.mime_type || "";
      if (mime.startsWith("image/") || mime.startsWith("video/")) {
        attachments.push({
          path: att.path,
          mime_type: mime,
          date: msg.date,
          sender: msg.sender,
          is_from_me: msg.is_from_me
        });
      }
    }
  }
  return attachments.sort((a, b) => (b.date || "").localeCompare(a.date || ""));
}

function renderGallery() {
  const attachments = collectAttachments();
  const grid = document.getElementById("galleryGrid");
  if (attachments.length === 0) {
    grid.innerHTML = '<div class="gallery-empty">No photos or videos</div>';
    return;
  }
  let html = "";
  for (const att of attachments) {
    const mime = att.mime_type || "";
    const dateStr = att.date ? att.date.substring(0, 10) : "";
    if (mime.startsWith("image/")) {
      html += `<div class="gallery-item" data-path="${escapeAttr(att.path)}" data-mime="${escapeAttr(mime)}">
        <img src="${escapeAttr(att.path)}" loading="lazy">
        <span class="date-badge">${dateStr}</span>
      </div>`;
    } else if (mime.startsWith("video/")) {
      html += `<div class="gallery-item" data-path="${escapeAttr(att.path)}" data-mime="${escapeAttr(mime)}">
        <video src="${escapeAttr(att.path)}" preload="metadata"></video>
        <span class="video-badge">▶</span>
        <span class="date-badge">${dateStr}</span>
      </div>`;
    }
  }
  grid.innerHTML = html;
  grid.querySelectorAll(".gallery-item").forEach(item => {
    item.addEventListener("click", () => openLightbox(item.dataset.path, item.dataset.mime));
  });
}

function openLightbox(path, mime) {
  const lb = document.createElement("div");
  lb.className = "lightbox";
  if (mime.startsWith("video/")) {
    lb.innerHTML = `<video src="${escapeAttr(path)}" controls autoplay></video><span class="lightbox-close">&times;</span>`;
  } else {
    lb.innerHTML = `<img src="${escapeAttr(path)}"><span class="lightbox-close">&times;</span>`;
  }
  lb.addEventListener("click", (e) => {
    if (e.target === lb || e.target.classList.contains("lightbox-close")) lb.remove();
  });
  document.body.appendChild(lb);
}

function toggleView() {
  viewMode = viewMode === "messages" ? "attachments" : "messages";
  document.getElementById("viewToggle").textContent = viewMode === "messages" ? "Attachments" : "Messages";
  document.getElementById("chatContainer").classList.toggle("hidden", viewMode === "attachments");
  document.getElementById("galleryContainer").classList.toggle("hidden", viewMode === "messages");
  document.getElementById("searchBox").classList.toggle("hidden", viewMode === "attachments");
  if (viewMode === "attachments") renderGallery();
}

document.getElementById("viewToggle").addEventListener("click", toggleView);

init();
</script>
</body>
</html>
